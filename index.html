<html>
	<head>
		<title>
			My city
		</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<style type="text/css">
			/*background*/
			.background {
				position:absolute;
				left:0px;
				top:0px;
				z-index:-1;
			}
			/*wall rear*/
			.over1 {
				position:absolute;
				left:0px;
				top:0px;
				z-index:1;
			}
			/*buildings*/
			.over2 {
				position:absolute;
				left:0px;
				top:0px;
				z-index:2;
			}
			/*wall front*/
			.over3 {
				position:absolute;
				left:0px;
				top:0px;
				z-index:3;
			}
			/*fire*/
			.fire {
				position:absolute;
				left:0px;
				top:0px;
				z-index:4;
			}
			.interface {
				position:absolute;
				left:0px;
				top:0px;
				z-index:99;
			}
			.resources{
				position: relative;
				left:0px;
			}
			#defence, #homes {
				width: 180px;
			}
			#console_n_chat {
				resize: none;
				overflow: auto;
			}
		</style>
	</head>
	<body>
		<canvas width="800" height="480" id="canvas" style="top:0px;left:0px;position:absolute;z-index:-1"></canvas>
		<script>
		var canvas  = document.getElementById("canvas");
		var ctx     = canvas.getContext("2d");
		
		var img1    = loadImage('resources/background_a.png', composite);
		var img2    = loadImage('resources/sawmill_a.png', composite);
		var img3    = loadImage('resources/gold_a.png', composite);
		var img4    = loadImage('resources/pop_a.png', composite);
		var img5    = loadImage('resources/home_a.png', composite);
		var img5_1  = loadImage('resources/house_a.png', composite);
		var img6_1  = loadImage('resources/wallsr_a.png', composite);
		var img6_2  = loadImage('resources/wallsf_a.png', composite);
		var img7    = loadImage('resources/castle_a.png', composite);
		var img8    = loadImage('resources/wishing_well_builded.png', composite);
		
		var msg_pop_limit_en     = "your city is reached population limit. Build new houses or upgrade existing ones";
		var msg_pop_limit        = msg_pop_limit_en;
		var msg_game_saved_en    = "game saved successfully";
		var msg_game_saved       = msg_game_saved_en;
		var msg_game_loaded_en   = "game loaded successfully";
		var msg_game_loaded       = msg_game_loaded_en;

		var imagesLoaded = 0;
		
		function composite() {
			imagesLoaded = imagesLoaded*1 + 1;
			if (imagesLoaded > 1) {
				// composite now
				//ctx.globalAlpha = 1.00;
				ctx.drawImage(img1, 0, 0);   //draw background
				ctx.drawImage(img2, 0, 0);   //draw sawmill
				ctx.drawImage(img3, 10, 40); //draw gold icon
				ctx.drawImage(img4, 10, 80); //draw pop  icon
				ctx.drawImage(img8, 0, 0); //draw wishing well
				if (buildLevelD > 0) {
					// draw back piece of wall
					ctx.drawImage(img6_1, 0, 0);
				}
				if (buildLevelH > 0 && buildLevelH < 10) {
					// draw houses
					ctx.drawImage(img5, 0, 0);
				}
				if (buildLevelH > 10) {
					// draw more houses
					ctx.drawImage(img5_1, 0, 0);
				}
				if (buildLevelD > 1) {
					// draw castle
					ctx.drawImage(img7, 0, 0);
				}
				if (buildLevelD > 0) {
					// draw front piece of wall
					ctx.drawImage(img6_2, 0, 0);
				}	
			}
		}
		
		function loadImage(src, onload) {
			var img = new Image();
			img.onload = onload;
			img.src = src;
			return img;
		}
		//composite();
		</script>
		<script>
		var url = window.location.pathname;
		var filename = url.substring(url.lastIndexOf('/')+1);
		
		if (filename == ""|| filename == "index.html" || filename =="index.htm" || filename =="index.php" || filename == "main2.html" || filename =="main.htm") {
			res_mod = "b";
		}
		else {
			res_mod = "b";
		}
		//alert(res_mod);
		/*
		function reload_res(this) {
		this.src=str.replace(\"_a\", res_mod);
		alert(this.src);
		}
		*/
		</script>
		welcome to heroes' city
		<br>
		<p id="resources">
			<span id="gold" class="interface" style="position:relative; left:35px">0</span>
			<br>
			<br>
			<span id="pop"  class="interface" style="position:relative; left:35px">2</span>
			<br>
		</p>
		<p id="constructions">
		
		</p>
		<button id="defence" onclick="Build('Wall')" class="interface" style="top:120px">Build walls: 2 gold</button>
		<button id="homes"   onclick="Build('Home')" class="interface" style="top:150px">Build home: 2 gold</button>
		<button id="saveGameButton"   onclick="saveGame()" class="interface" style="top:200px">Save game</button>
		<button id="loadGameButton"   onclick="loadGame()" class="interface" style="top:230px">Load game</button>
		<!--
		<iframe id="constructionWindow" src="construction.html" class="interface" style="left:600px" width="1" height="1"></iframe>
		<button id="constructionButton" onclick="maximizew('construction')" class="interface" style="top:260px">Open construction menu</button>
		-->
		<p id="console_n_chat_div" style="top:480px" class="interface">
		<textarea id="console_n_chat" name="console_n_chat" class="interface" value="" style="width:800px"></textarea>
		</p>
	<script>
	//init variables
	var gold          = 20;
	var pop           = 2;
	var buildLevelD   = 0;
	var buildLevelH   = 0;
	//init const-variables
	var costWall      = 2;
	var costTower     = 4;
	var costHome      = 2;
	var lotteryPrize  = 50;
	//init service variables
	var redraw        = 0;
	var whatDraw      = "";
	var minBL         = 0;

	updateResources();
	//init timers
	setInterval(resourcesTimer, 30000);
	setInterval(rndEvents, 100000);
	setInterval(redrawTimer, 20);
	
	//functions
	function saveGame() {
		localStorage.setItem('gold', gold);
		localStorage.setItem('pop', pop);
		localStorage.setItem('buildLevelD', buildLevelD);
		localStorage.setItem('buildLevelH', buildLevelH);
		document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+msg_game_saved;
		scrollDown();
	}
	function loadGame() {
		gold = localStorage.getItem('gold');
		pop  = localStorage.getItem('pop');
		buildLevelD = localStorage.getItem('buildLevelD');
		buildLevelH = localStorage.getItem('buildLevelH');
		composite();
		updateResources();
		updateButtonCaptions();
		document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+msg_game_loaded;
		scrollDown();
	}
	function updateButtonCaptions(){
		nextLvl      = buildLevelH*1+1;
		nextLvlPrice = Math.pow(costHome,(buildLevelH*1+1));
		document.getElementById("homes").innerHTML="Build home lvl"+nextLvl+"; "+nextLvlPrice+" gold";

		if (buildLevelD == 1) {
			document.getElementById("defence").innerHTML="Build Tower: "+costTower+" gold";	
			var towerClick = "Build("+"\'Tower\'"+")";
			document.getElementById("defence").setAttribute("onclick", towerClick);
		}
		if (buildLevelD == 2) {
			document.getElementById("defence").setAttribute("style", "display:none");
		}
	}
	function getTime(type) {
	    var d = new Date();
	    var hh = d.getHours();
	    var mm = d.getMinutes();
	    var ss = d.getSeconds();
	    if (hh < 10) {
	    	hh = "0"+hh;
	    }
	    if (mm < 10) {
	    	mm = "0"+mm;
	    }
	    if (ss < 10) {
	    	ss = "0"+ss;
	    }
	    if (type=="0") {
	    	n = hh+":"+mm;	
	    }
	    if (type=="1") {
	    	n = hh+":"+mm+":"+ss;	
	    }
	    return n;
	}
	function scrollDown(){
   		var textarea = document.getElementById("console_n_chat");
		    if(textarea.selectionStart == textarea.selectionEnd) {
			textarea.scrollTop = textarea.scrollHeight;
	   		}
	}
	function updateResources() {
		document.getElementById("gold").innerHTML = gold;
		document.getElementById("pop").innerHTML  = pop;
	}
	function Build(Structure) {
		if (Structure=="Wall" || Structure =="Tower") {
			if (gold >= costWall && buildLevelD == 0) { 
				buildLevelD = buildLevelD*1 + 1;
				gold = gold - costWall;
				redraw   = 1;
				whatDraw = "Wall";
				updateResources();
				return true;
			}
			if (gold >= costTower && buildLevelD == 1) { 
				buildLevelD = buildLevelD*1 + 1;
				gold = gold - costTower;
				redraw   = 1;
				whatDraw = "Tower";
				updateResources();
				return true;
			}
		}
		if (Structure=="Home") {
			if (gold >= Math.pow(costHome,(buildLevelH*1 + 1))) {
				gold = gold - Math.pow(costHome,(buildLevelH*1 + 1));
				redraw   = 1;
				whatDraw = "Home";
				buildLevelH = buildLevelH*1 + 1;
				updateResources();
				return true;
			}
		}
	}
	function Draw(Structure){
		if (Structure == "Wall"){
			composite();
			updateButtonCaptions();
		}
		if (Structure == "Tower"){
			composite();
			updateButtonCaptions();
		}
		if (Structure == "Home"){
			if (buildLevelH == 1) {
				composite();
			}
			updateButtonCaptions();
		}
		if (Structure == "House"){
			document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+house;
			//update interface
			document.getElementById("homes").setAttribute("style", "display:none");
		}
	}
	function maximizew() {
		//var mxmw = document.getElementById("constructionWindow");
		document.getElementById("constructionWindow").setAttribute("width", 195);
		document.getElementById("constructionWindow").setAttribute("height", 400);
		
	}
	function minimizew() {
		//var mxmw = document.getElementById("constructionWindow");
		document.getElementById("constructionWindow").setAttribute("width", 1);
		document.getElementById("constructionWindow").setAttribute("height", 1);
	}
	//timers
	function redrawTimer() {
		//cookies = document.cookie.split(';');
		//document.getElementById('dbg').innerHTML = minimizeBl;
		if (redraw == 1) {
			Draw(whatDraw);
			redraw = 0;
			whatDraw  = "";
		}
		if (minBL == 1) {
			minimizew();
			minBL=0;
		}
		return;
	}
	function resourcesTimer() {
		pop_m    = 0;
		gold     = gold*1+pop*1;
		//gold     = gold*1+2;
		if (pop < 2*Math.pow((buildLevelH*1+3),2)) {
			pop      = pop*1+1;
			pop_m    = 1;
		} else {
			document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+msg_pop_limit;
		}
		if (pop_m == 0) {
			msg   = "amount of money are increased!";
		}
		if (pop_m == 1) {
			msg   = "population and amount of money are increased!";
		}
		document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+msg;
		scrollDown();
		updateResources();
	}
	function rndEvents() {
		rnd = Math.floor((Math.random() * 12) + 1);
		
		switch (rnd) {
			case 1:
				//document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"&#13;&#10;"+'shit happens!';				
				alert('shit happens');
				break;
			case 2:
				alert('fire in the city!');
				
				var ceil = 0;
				if (buildLevelD == 1) {
					ceil = 1
				}
				if (buildLevelD == 2) {
					ceil = 2
				}
				rnd = Math.floor((Math.random() * 2) + 0);
				if (rnd == 0) {
					document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
				}
				if (rnd == 1) {
					document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
				}
				if (rnd == 0) {
					document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
				}
				break;
			case 3:
				//
				break;
			case 4:
				//
				break;
			case 5:
				//
				break;
			case 6:
				//
				break;
			case 7:
				//
				break;
			case 8:
				//
				break;
			case 9:
				//
				break;
			case 10:
				//
				break;
			case 11:
				//
				break;
			case 12:
				alert("You won a lottery with "+lotteryPrize+" gold prize");
				gold = gold + lotteryPrize;
				break;
			default:
				alert("error on switch/case function");
		}
	}
	</script>
	</body>
</html>