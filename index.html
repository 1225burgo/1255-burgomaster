<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>
		1255 Burgomaster
	</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<style type="text/css">
		/*canvas*/
		.canvas {
			left:0px;
			top:-6px;
			position:relative;
		}
		/*background*/
		.background {
			position:absolute;
			left:0px;
			top:0px;
			z-index:-1;
		}
		/*wall rear*/
		.over1 {
			position:absolute;
			left:0px;
			top:0px;
			z-index:1;
		}
		/*buildings*/
		.over2 {
			position:absolute;
			left:0px;
			top:0px;
			z-index:2;
		}
		/*wall front*/
		.over3 {
			position:absolute;
			left:0px;
			top:0px;
			z-index:3;
		}
		/*fire*/
		.fire {
			position:absolute;
			left:0px;
			top:0px;
			z-index:4;
		}
		.interface {
			position:absolute;
			left:0px;
			top:0px;
			z-index:99;
		}
		.resources{
			position: relative;
			left:0px;
		}
		/*
		#defence, #homes, #treasury {
			width: 180px;
		}
		#buttonBldGallows, #buttonBldFountain, #buttonBldStash {
			width: 180px;
		}*/
		#console_n_chat {
			resize: none;
			overflow: auto;
		}
		/* Style the tab */
		div.tab {
			overflow: hidden;
			border: 1px solid #ccc;

			width: 800px;
			background-color: #f1f1f1;
		}

		/* Style the buttons inside the tab */
		div.tab button {
			background-color: inherit;
			float: left;
			border: none;
			outline: none;
			cursor: pointer;
			padding: 14px 16px;
			transition: 0.3s;
			font-size: 17px;
		}
		td.building {
			width:180px;
		}
		button.building {
			width:180px;
		}
		/* Change background color of buttons on hover */
		div.tab button:hover {
			background-color: #ddd;
		}

		/* Create an active/current tablink class */
		div.tab button.active {
			background-color: #ccc;
		}

		/* Style the tab content */
		.tabcontent {
			display: none;
			padding: 6px 0px;
			border: 1px solid #ccc;
			border-top: none;
			height: 470px;
			width: 800px;/*800-12*2*/
		}

		/* Style the close button */
		.topright {
			float: right;
			cursor: pointer;
			font-size: 20px;
		}
		.topright:hover {color: red;}
		#lblAboutGame {
			width: 795px;
			height: 475px;
			border: thin solid black;
			overflow:scroll;
			/*
            overflow-x: hidden;
            overflow-y: scroll;
            */
		}
		#theBuildingDiv {
			width: 795px;
			height: 415px;
			border: thin solid black;
			overflow:scroll;
			/*
            overflow-x: hidden;
            overflow-y: scroll;
            */
		}
	</style>
	<script id="chatBroEmbedCode">
		/* Chatbro Widget Embed Code Start */
		function ChatbroLoader(chats,async){async=!1!==async;var params={embedChatsParameters:chats instanceof Array?chats:[chats],lang:navigator.language||navigator.userLanguage,needLoadCode:'undefined'==typeof Chatbro,embedParamsVersion:localStorage.embedParamsVersion,chatbroScriptVersion:localStorage.chatbroScriptVersion},xhr=new XMLHttpRequest;xhr.withCredentials=!0,xhr.onload=function(){eval(xhr.responseText)},xhr.onerror=function(){console.error('Chatbro loading error')},xhr.open('GET','//www.chatbro.com/embed.js?'+btoa(unescape(encodeURIComponent(JSON.stringify(params)))),async),xhr.send()}
		/* Chatbro Widget Embed Code End */
		ChatbroLoader({encodedChatId: '1Leg'});
	</script>
</head>
<body>
<span id="html">
		<script>
			var url = window.location.pathname;
			var filename = url.substring(url.lastIndexOf('/')+1);
			if (filename == ""|| filename == "index.html" || filename =="index.htm" || filename =="index.php" || filename == "main2.html" || filename =="main.htm") {
				res_mod = "b";
			}
			else {
				res_mod = "b";
			}
			//alert(res_mod);
			/*
			function reload_res(this) {
			this.src=str.replace(\"_a\", res_mod);
			alert(this.src);
			}
			*/
		</script>
		<div class="tab">
			<button class="tablinks" onclick="openTab(event, 'Main')" id="tabCity">Main</button>
			<button class="tablinks" onclick="openTab(event, 'Explore')" id="tabExplore" style="display:none">Explore</button>
			<button class="tablinks" onclick="openTab(event, 'Settings')" id="tabSettings">Settings</button>
			<button class="tablinks" onclick="openTab(event, 'Garrison')" id="tabGarrison">Garrison</button>
			<button class="tablinks" onclick="openTab(event, 'Building')" id="tabBuilding">Building</button>
			<button class="tablinks" onclick="openTab(event, 'About')" id="tabAbout">How To Play</button>
			<button class="tablinks" onclick="openTab(event, 'Discord')" id="tabDiscord">Discord</button>
			<!--<a href="https://www.patreon.com/bePatron?u=7838459" target="_blank"><img src="resources/patreon.png" style="padding: 6px 0px"></a>-->
		</div>
		<div id="Main" class="tabcontent">
			<canvas width="800" height="480" id="canvas" class="canvas" style="z-index:1"></canvas>
			<br>
			<p id="resources">
				<span id="gold" class="interface" onclick="game.add_money()" style="position:absolute; top:100px; left:60px">0</span>
				<br>
				<br>
				<span id="pop"  class="interface" onclick="checkPop()" style="position:absolute; top:140px; left:60px">2</span>
				<br>
			</p>
			<p id="events_graphics" style="z-index: 8">

			</p>
			<!--<img src="resources/fire_a.gif" id="fire_graphics" onclick="putOutFire()" style="position:absolute; top:170px; left:0px; z-index=98; display:none">-->
			<button id="saveGameButton"   onclick="saveGame()" class="interface" style="top:290px; left: 20px">Save game</button>
			<button id="loadGameButton"   onclick="loadGame()" class="interface" style="top:350px; left: 20px">Load game</button>
			<button id="buttonPutOutFire"   onclick="game.putOutFire()" class="interface" style="top:390px; left: 20px; display:none">Put out fire</button>
			<button id="buttonDeathPenalty"   onclick="game.deathPenalty()" class="interface" style="top:430px; left: 20px; display:none">Execute smb</button>
			<button id="buttonDebug"   onclick="ym(47225574, 'reachGoal', 'min5'); return true;" class="interface" style="top:190px; left: 20px; display:none">X</button>
			<!--
			<iframe id="constructionWindow" src="construction.html" class="interface" style="left:600px" width="1" height="1"></iframe>
			<button id="constructionButton" onclick="maximizew('construction')" class="interface" style="top:260px">Open construction menu</button>
			-->
		</div>
		<div id="Explore" class="tabcontent">
			<canvas width="800" height="480" id="canvasMap" class="canvas" style="z-index:1"></canvas>
			<p style="position:absolute; top:60px; left: 20px">
			GLOBALMAP
			</p>
		</div>
		<div id="Settings" class="tabcontent">
			<!--<span onclick="this.parentElement.style.display='none'" class="topright">x</span>-->
			<h3><div id="labelSettings">Settings</div></h3>
			<!-- TODO make checkboxes with chat system messages -->
			<!--<p>Alert / MSG to chat</p>-->
			<table>
			<tr>
				<!-- TODO make a message about turning on / off autosaves for color disabled people -->
				<td><div id="labelAutosave">Autosave</div><img id="autosaveImg" onclick="changeAutosave()" src="resources/button_red.png"></td>
				<td><button id="buttonExportGame" onclick="exportGame()" >Export Game</button></td>
				<td><button id="buttonImportGame" onclick="importGame()" >Import Game</button></td>
			</tr>
			</table>
			<input id="savestring" name="savestring" value="" style="width:600px">
			<div style="position: absolute; top: 120px; left:500px">
			<select id="selectLng" size="1" onchange="reloadLang()">
				<option id="optionLngEn" selected value="en-US">English</option>
				<option id="optionLngRu"          value="ru-RU">Русский</option>
				<option id="optionLngGe"          value="de-DE">Deutsch</option>
			</select>
			</div>
			<textarea id="patchnotes" class="interface" value="" style="width:700px; height:300px; top:230px; left:40px"></textarea>
		</div>
		<div id="Garrison" class="tabcontent">
			<!--<span onclick="this.parentElement.style.display='none'" class="topright">x</span>-->
			<h3><div id="labelGarrison">Garrison</div></h3>
			<div id="divtreasuryGuard">
			<table border="1">
				<tr>
					<td>
						<div align="center">
							<img src="resources/knight6.png">
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<button id="buttonFireGuard" onclick="game.fireTreasuryGuard()" style="width:80px">Fire</button>
						<span id="treasuryGuard">0</span>
						<button id="buttonHireGuard" onclick="game.hireTreasuryGuard()" style="width:80px">Hire</button>
						<!--<button id="fireGuard" onclick="fireTreasuryGuard()" class="interface" style="top:170px; left:20px; width:80px">Fire</button>
						<span id="treasuryGuard" class="interface" style="position:absolute; top:170px; left:120px">0</span>
						<button id="hireGuard" onclick="hireTreasuryGuard()" class="interface" style="top:170px; left:180px;-->
					</td>
				</tr>
			</table>
			</div>
		</div>
		<div id="Building" class="tabcontent">
			<!--<span onclick="this.parentElement.style.display='none'" class="topright">x</span>-->
			<h3><div id="labelBuilding">Building</div></h3>
			<div id="theBuildingDiv">
				<table border="1">
					<tr>
						<td class="building">
							<div align="center">
								<img id="defencies_img" src="resources/wallsf_as2.png">
							</div>
						</td>
						<td class="building">
							<div align="center">
								<img src="resources/home_as.png">
							</div>
						</td>
						<td class="building">
							<div align="center">
								<img src="resources/treasury_as.png">
							</div>
						</td>
					</tr>
					<tr>
						<td class="building">
							<button id="defence" onclick="game.Build('Wall')" class="building">Build walls</button>
						</td>
						<td class="building">
							<button id="homes" onclick="game.Build('Home')" class="building">Build home</button>
						</td>
						<td class="building">
							<button id="treasury" onclick="game.Build('Treasury')" class="building">Build treasury</button>
						</td>
					</tr>
					<tr>
						<td class="building">
							<div align="center">
								<img src="resources/gallows.png">
							</div>
						</td>
						<td class="building">
							<div align="center">
								<img src="resources/fountain.png">
							</div>
						</td>
						<td class="building">
							<div align="center">
								<img src="resources/trapdoor.png">
							</div>
						</td>
					</tr>
					<tr>
						<td class="building">
							<button id="buttonBldGallows" onclick="game.Build('Gallows')" class="building">Build gallows</button>
						</td>
						<td class="building">
							<button id="buttonBldFountain" onclick="game.Build('Fountain')" class="building">Build fountain</button>
						</td>
						<td class="building">
							<button id="buttonBldStash" onclick="game.Build('Stash')" class="building">Build stash</button>
						</td>
					</tr>
					<tr>
						<td class="building">
							<div align="center">
								<img src="resources/inn.png">
							</div>
						</td>
						<td class="building">
							<div align="center">

							</div>
						</td>
						<td class="building">
							<div align="center">

							</div>
						</td>
					</tr>
					<tr>
						<td class="building">
							<button id="buttonBldInn" onclick="game.Build('Inn')" class="building">Build Inn</button>
						</td>
						<td class="building">

						</td>
						<td class="building">

						</td>
					</tr>
					</table>
			</div>
		</div>
		<div id="About" class="tabcontent">
			<div id="lblAboutGame">
			<h1>1255 Burgomaster</h1><br>
			<h2>How to play</h2>
			</div>
		</div>
		<div id="tabPopulation" class="tabcontent">
			<div id="popStatK">
			
			</div>
			<div id="popStatV">
			
			</div>
			<button id="btnPopAtStart"  onclick="PopAtStart()" style="width:80px"><<</button>
			<button id="btnPopPrev"     onclick="PopPrev()" style="width:80px"><</button>
			<button id="btnPopNext"     onclick="PopNext()" style="width:80px">></button>
			<button id="btnPopAtEnd"    onclick="PopAtEnd()" style="width:80px">>></button>
		</div>
		<div id="Discord" class="tabcontent">
			<iframe src="https://discordapp.com/widget?id=564554640755130409&theme=light" width="800" height="470" allowtransparency="true" frameborder="0"></iframe>
		</div>
		<p id="console_n_chat_div" style="top:530px; left:10px" class="interface">
			<textarea id="console_n_chat" name="console_n_chat" class="interface" value="" style="width:800px; height:150px"></textarea>
		</p>
		<canvas id="myDCanvas" width="600" height="200" style="position: absolute; left: 20px; top: 100px; z-index: -2; visible:none">
		Your browser does not support the HTML5 canvas tag.</canvas>
</span>
<script>
	//TOWN
	canvas  = document.getElementById("canvas");
	canvas.addEventListener("touchstart", tap);
	canvas.addEventListener("mousedown", tap);
	languageDefined = 0;
	var ctx     = canvas.getContext("2d");
	var img1    = loadImage('resources/background_a.png', composite);//use forward slashes for Linux and Windows compatible. \ this slash works only in Windows.
	var img2    = loadImage('resources/sawmill_a.png', composite);
	var sawmillX     = 670;
	var sawmillY	 = 65;
	var sawmillW     = 110;
	var sawmillH     = 56;
	var img3    = loadImage('resources/gold_a.png', composite);
	var goldX        = 10;
	var goldY   	 = 40;
	var goldW        = 28;
	var goldH        = 22;
	var img4    = loadImage('resources/pop_a.png', composite);
	var popX         = 10;
	var popY   	     = 80;
	var popW         = 29;
	var popH         = 22;
	var img5    = loadImage('resources/home_as.png', composite);
	var homeX        = 90;
	var homeY   	 = 160;
	var homeW        = 80;
	var homeH        = 90;
	var img5_1  = loadImage('resources/house_as.png', composite);
	var houseX       = 90;
	var houseY   	 = 160;
	var houseW       = 113;
	var houseH       = 125;
	var img6_1  = loadImage('resources/wallsr_a.png', composite);
	var img6_2  = loadImage('resources/wallsf_a.png', composite);
	var wallX        = 330;
	var wallY   	 = 400;
	var wallW        = 110;
	var wallH        = 65;
	var img7    = loadImage('resources/castle_as.png', composite);
	var castleX      = 300;
	var castleY      = 160;
	var castleW      = 180;
	var castleH      = 160;
	var img8    = loadImage('resources/wishing_well_builded.png', composite);
	var wellX        = 230;
	var wellY      	 = 200;
	var wellW        = 41;
	var wellH        = 47;
	var img9    = loadImage('resources/treasury_as.png', composite);
	var treasuryX    = 200;
	var treasuryY    = 270;
	var treasuryW    = 125;
	var treasuryH    = 120;
	var img10   = loadImage('resources/gallows.png', composite);
	var gallowsX     = 485;
	var gallowsY   	 = 270;
	var gallowsW     = 50;
	var gallowsH     = 75;
	var img11   = loadImage('resources/fountain.png', composite);
	var fountainX    = 485;
	var fountainY    = 290;
	var fountainW    = 70;
	var fountainH    = 55;
	var img12   = loadImage('resources/trapdoor.png', composite);
	//var img13 is already used in fire singleton
	var img14   = loadImage('resources/inn.png', composite);
	var innX = 270;
	var innY = 80;
	var innW = 87;
	var innH = 79;
	var img15   = loadImage('resources/fire_a.gif', composite);
	img15.id      = "fire_graphics";
	buildingsInTownB=[];
	buildingsInTownX=[];
	buildingsInTownY=[];
	buildingsInTownW=[];
	buildingsInTownH=[];
	function deleteFromArray (arrayToMod, indexToDelete) {
		arrayLenght                = arrayToMod.length;
		tArrayBeforeDeletedElement = arrayToMod.slice(0,indexToDelete);
		tArrayAfterDeletedElement  = arrayToMod.slice(indexToDelete+1,arrayToMod.length);
		tResultArray               = tArrayBeforeDeletedElement.concat(tArrayAfterDeletedElement);
		return tResultArray;
	}
	function removeFromArrays (elementIndex) {
		buildingsInTownB = deleteFromArray(buildingsInTownB, elementIndex);
		buildingsInTownX = deleteFromArray(buildingsInTownX, elementIndex);
		buildingsInTownY = deleteFromArray(buildingsInTownY, elementIndex);
		buildingsInTownW = deleteFromArray(buildingsInTownW, elementIndex);
		buildingsInTownH = deleteFromArray(buildingsInTownH, elementIndex);
	}
	var Singleton = (function () {
		var instance;
		function createInstance() {
			var object = loadImage('resources/fire_static.png');
			return object;
		}
		return {
			getInstance: function () {
				if (!instance) {
					instance = createInstance();
				}
				return instance;
			}
		};
	})();
	//var imagesLoaded = 0;
	function pushBuilding(buildingName, buildingX, buildingY, buildingW, buildingH){
		if (buildingsInTownB.indexOf(buildingName)==-1) {
			if (buildingName==='house') {
				removeIndex = buildingsInTownB.indexOf('home');
				removeFromArrays(removeIndex);
			}
			if (buildingName==='swall') {
				removeIndex = buildingsInTownB.indexOf('wall');
				removeFromArrays(removeIndex);
			}
			if (buildingName==='scastle') {
				removeIndex = buildingsInTownB.indexOf('scastle');
				removeFromArrays(removeIndex);
			}
			buildingsInTownB.push(buildingName);
			buildingsInTownX.push(buildingX);
			buildingsInTownY.push(buildingY);
			buildingsInTownW.push(buildingW);
			buildingsInTownH.push(buildingH);
		}
	}
	function composite() {
		ctx.drawImage(img1, 0, 0);   //draw background
		ctx.drawImage(img2, sawmillX, sawmillY);//draw sawmill
		pushBuilding('sawmill', sawmillX, sawmillY, sawmillW, sawmillH);
		ctx.drawImage(img3, goldX, goldY); //draw gold icon
		pushBuilding('gold', goldX, goldY, goldW, goldH);
		ctx.drawImage(img4, popX, popY); //draw pop  icon
		pushBuilding('pop', popX, popY, popW, popH);
		ctx.drawImage(img8, wellX, wellY); //draw wishing well
		pushBuilding('well', wellX, wellY, wellW, wellH);
		if (game.buildLevelD > 0) {
			// draw back piece of wall
			ctx.drawImage(img6_1, 0, 0);
		}
		if (game.buildLevelH > 0 && game.buildLevelH < 10) {
			// draw homes
			ctx.drawImage(img5, homeX, homeY);
			pushBuilding('home', homeX, homeY, homeW, homeH);
		}
		if (game.buildLevelH >= 10) {
			// draw more houses
			ctx.drawImage(img5_1, houseX, houseY);
			pushBuilding('house', houseX, houseY, houseW, houseH);
		}
		if (game.buildLevelD > 1) {
			// draw castle
			ctx.drawImage(img7, castleX, castleY);
			pushBuilding('castle', castleX, castleY, castleW, castleH);
		}
		if (game.buildLevelTreasury > 0) {
			// draw treasury
			ctx.drawImage(img9, treasuryX, treasuryY);
			pushBuilding('treasury', treasuryX, treasuryY, treasuryW, treasuryH);
		}
		if (game.buildLevelGallows > 0) {
			// draw gallows
			ctx.drawImage(img10, gallowsX, gallowsY);
			pushBuilding('gallows', gallowsX, gallowsY, gallowsW, gallowsH);
		}
		if (game.buildLevelFountain > 0) {
			// draw fountain
			ctx.drawImage(img11, fountainX, fountainY);
			pushBuilding('fountain', fountainX, fountainY, fountainW, fountainH);
		}
		if (game.buildLevelStash > 0) {
			// draw stash
			//We do not draw a secret Stash under the Treasury. It's a secret, are you understand?!
			//ctx.drawImage(img12, 0, 0);
		}
		if (game.buildLevelInn > 0) {
			ctx.drawImage(img14, innX, innY);
			pushBuilding('inn', innX, innY, innW, innH);
		}
		if (game.buildLevelD > 0) {
			// draw front piece of wall
			ctx.drawImage(img6_2, 0, 0);
			//pushing gatehouse of the wall
			pushBuilding('wall', wallX, wallY, wallW, wallH);
		}
		if (game.fire === 1) {
			img15.style   = 'position:absolute; top:370px; left:200px; z-index:8';
			document.getElementById("events_graphics").appendChild(img15);
			//img15.style   = 'position:absolute; top:170px; left:0px; z-index:8';
			document.getElementById("fire_graphics").setAttribute("onclick", "game.putOutFire()");
			document.getElementById("buttonPutOutFire").setAttribute("style", "top:390px; left: 20px; display:true");

		}
	}
	function loadImage(src, onload) {
		var img = new Image();
		img.onload = onload;
		img.src = src;
		return img;
	}
	function getElementPosition (element) {
		//thanks to William Alone
		var parentOffset,
				pos = {
					x: element.offsetLeft,
					y: element.offsetTop
				};
		if (element.offsetParent) {
			parentOffset = getElementPosition(element.offsetParent);
			pos.x += parentOffset.x;
			pos.y += parentOffset.y;
		}
		return pos;
	}
	function tap (e) {
		pos = getElementPosition(canvas);
		loc = {};
		tapX = e.targetTouches ? e.targetTouches[0].pageX : e.pageX;
		tapY = e.targetTouches ? e.targetTouches[0].pageY : e.pageY;
		canvasScaleRatio = canvas.width / canvas.offsetWidth;
		loc.x = (tapX - 9) * canvasScaleRatio;
		loc.y = (tapY - 58) * canvasScaleRatio;
		for (i=0;i<buildingsInTownB.length;i++){
			if (loc.x >= buildingsInTownX[i] && loc.x <= buildingsInTownX[i]+buildingsInTownW[i]) {
				if (loc.y >= buildingsInTownY[i] && loc.y <= buildingsInTownY[i]+buildingsInTownH[i]) {
					console.log(buildingsInTownB[i]);
					buildingClick(buildingsInTownB[i]);
				}
			}
		}
	}
	function buildingClick(buildingName){
		var showAlert = true;
		if (buildingName==='well') {
			alertMsg = localeStrings[132];
		}
		if (buildingName==='gold') {
			alertMsg = localeStrings[144];
		}
		if (buildingName==='pop') {
			//alertMsg = localeStrings[145];
			showAlert = false;
			checkPop();
		}
		if (buildingName==='sawmill') {
			alertMsg = localeStrings[133];
		}
		if (buildingName==='wall') {
			alertMsg = localeStrings[134];
		}
		if (buildingName==='swall') {
			alertMsg = localeStrings[135];
		}
		if (buildingName==='home') {
			alertMsg = localeStrings[138];
		}
		if (buildingName==='house') {
			alertMsg = localeStrings[139];
		}
		if (buildingName==='castle') {
			alertMsg = localeStrings[136];
		}
		if (buildingName==='scastle') {
			alertMsg = localeStrings[137];
		}
		if (buildingName==='inn') {
			alertMsg = localeStrings[140];
		}
		if (buildingName==='gallows') {
			alertMsg = localeStrings[141];
		}
		if (buildingName==='fountain') {
			alertMsg = localeStrings[142];
		}
		if (buildingName==='treasury') {
			alertMsg = localeStrings[143];
		}
		if (showAlert === true) {
			showModal(0, '', getAck, alertMsg,  localeStrings[60], '')
		}
	}
	//composite();
</script>
<script>
	//GLOBALMAP
	var canvas_map      = document.getElementById("canvasMap");
	var ctx_map         = canvas_map.getContext("2d");
	var tile_grass      = loadImage('tiles/grass.png');//use forward slashes for Linux and Windows compatible. \ this slash works only in Windows.
	var tile_sand       = loadImage('tiles/sand.png');
	var tile_snow       = loadImage('tiles/snow.png');
	var tile_water      = loadImage('tiles/water.png');
	var castle_tile     = loadImage('resources/castle_big.png');
	var hero_tile       = loadImage('resources/someKnight3.png');
	var tree_tile       = loadImage('resources/tree.png');
	function composite_gm() {
		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				if (game.myMapLand[i][j]===0) {
					ctx_map.drawImage(tile_grass, i * 48, j * 48);   //draw background
				}
			}
		}
		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				if (game.myMapLand[i][j]===0) {
					//ctx_map.drawImage(tile_grass, i * 48, j * 48);   //draw background
				}
				if (game.myMapObjects[i][j]===1) {
					//console.log("draw tree");
					ctx_map.drawImage(tree_tile, i * 48, j * 48);   //draw castle entrance
				}
				if (game.myMapObjects[i][j]===2) {
					//console.log("draw tree");
					ctx_map.drawImage(tree_tile, i * 48, j * 48);   //draw castle entrance
				}
				if (game.myMapObjects[i][j]===3) {
					//console.log("draw tree");
					ctx_map.drawImage(tree_tile, i * 48, j * 48);   //draw castle entrance
				}
				if (game.myMapObjects[i][j]===12) {
					console.log("draw castle");
					ctx_map.drawImage(castle_tile, i * 48, j * 48);   //draw castle entrance
				}
				if (game.myMapRemObjects[i][j]===40) {
					console.log("draw hero");
					ctx_map.drawImage(hero_tile, i * 48, j * 48);   //draw hero
				}
			}
		}
	}
</script>
<script>
	include = function (url, fn) {
		var e = document.createElement("script");
		e.onload = fn;
		e.src = url;
		e.async=true;
		document.getElementsByTagName("head")[0].appendChild(e);
	};
	//init variables
	var game = {
		gold:20,
		pop:2,
		season:2, //1 - Winter, 2 - Spring, 3 - Summer, 4 - Autumn
		year:1255,
		food:20,
		treasuryGuard:0,
		buildLevelD:0,
		buildLevelH:0,
		buildLevelTreasury:0,
		buildLevelGallows:0,
		buildLevelFountain:0,
		buildLevelStash:0,
		buildLevelInn:0,
		fire:0,
		hero:0,
		happyness:80,
		o_autosave:0,
		saveVersion:"saveV1006",
		myGlobalMap: [],
		myMapLand: [],
		castleX: 1,
		castleY: 1,
		myMapObjects: [],
		myMapRemObjects: [],
		years: [],
		pops: [],
		budgets: [],
		goldLimit : function () {
			return Math.pow(config.costTreasury,(game.buildLevelTreasury*1+1))*2+500;
		},
		createTheGlobalMap : function () {
			for (i = 0; i < 4; i++) {
				for (j = 0; j < 4; j++) {
					game.myGlobalMap[i][j] = 1;
				}
			}
		},
		recordStats : function() {
			game.years.push(game.year+" "+game.season);
			game.budgets.push(game.gold);
			game.pops.push(game.pop);
		},
		calculateTurn : function() {
			game.recordStats();
			pop_m         = 0;
			pop_was       = game.pop;
			game.season   = game.season + 1;
			if (game.season === 5) {
				game.season   = 1;
				game.year     = game.year+1;
			}
			gold_was      = game.gold;
			gold_limit    = game.goldLimit();
			gold_possible = game.gold*1+Math.round(game.pop*(1+game.buildLevelGallows*1/10),0);
			if (gold_possible > gold_limit) {
				game.gold      = gold_limit;
				msg = localeStrings[3];
				postEventLog(msg);
			} else {
				game.gold      = gold_possible;
			}
			if (game.pop < 2*Math.pow((game.buildLevelH*1+3),2)) {
				pop_incr = Math.round((game.pop*20/1000)*(1+game.buildLevelFountain*1/10),0)
				if (pop_incr == 0) {
					game.pop = game.pop*1+1;
				} else {
					game.pop = game.pop*1+pop_incr*1;
				}
				pop_m    = 1;
			} else {
				postEventLog(localeStrings[10]);
			}
			if (game.treasuryGuard > 0) {
				if (game.gold - game.treasuryGuard * config.treasuryGuardPricePayroll >= 0) {
					game.gold = game.gold - game.treasuryGuard * config.treasuryGuardPricePayroll;
				}
				else {
					//fire guards which we cannot afford
					//for now fire all guards!
					//TODO fire only those who we cannot afford
					game.treasuryGuard = 0;
					msg   = localeStrings[37];
					postEventLog(msg);
				}
			}
			if (game.gold !== gold_was) {
				if (game.gold > gold_was) {
					msg = localeStrings[4];
				} else {
					msg = localeStrings[5];
				}
				postEventLog(msg);
			};
			if (game.pop !== pop_was) {
				if (game.pop > pop_was) {
					msg = localeStrings[7];
				} else {
					msg = localeStrings[8];
				}
				postEventLog(msg);
			};
			cnt_cursession = cnt_cursession+1;
			if (cnt_cursession===10) {
				//ym(47225574, 'reachGoal', 'min5');
				//return true;

			}
			updateResources();
		},
		Build : function (Structure) {
			if (Structure==="Wall" || Structure ==="Tower") {
				if (game.gold >= config.costWall && game.buildLevelD == 0) {
					game.buildLevelD        = game.buildLevelD*1 + 1;
					game.gold               = game.gold - config.costWall;
					commonBuild();
					return true;
				}
				if (game.gold >= config.costTower && game.buildLevelD == 1) {
					game.buildLevelD        = game.buildLevelD*1 + 1;
					game.gold               = game.gold - config.costTower;
					commonBuild();
					return true;
				}
			}
			if (Structure==="Home") {
				if (game.gold >= Math.pow(config.costHome,(game.buildLevelH*1 + 1))) {
					game.gold               = game.gold - Math.pow(config.costHome,(game.buildLevelH*1 + 1));
					game.buildLevelH        = game.buildLevelH*1 + 1;
					commonBuild();
					return true;
				}
			}
			if (Structure==="Treasury") {
				if (game.gold >= Math.pow(config.costTreasury,(game.buildLevelTreasury*1 + 1))) {
					game.gold               = game.gold - Math.pow(config.costTreasury,(game.buildLevelTreasury*1 + 1));
					game.buildLevelTreasury = game.buildLevelTreasury*1 + 1;
					commonBuild();
					return true;
				}
			}
			if (Structure==="Gallows") {
				if (game.gold >= Math.pow(config.costGallows,(game.buildLevelGallows*1 + 1)) && game.buildLevelFountain == 0) {
					game.gold               = game.gold - Math.pow(config.costGallows,(game.buildLevelGallows*1 + 1));
					game.buildLevelGallows  = game.buildLevelGallows*1 + 1;
					commonBuild();
					return true;
				}
			}
			if (Structure==="Fountain") {
				if (game.gold >= Math.pow(config.costFountain,(game.buildLevelFountain*1 + 1)) && game.buildLevelGallows == 0) {
					game.gold               = game.gold - Math.pow(config.costFountain,(game.buildLevelFountain*1 + 1));
					game.buildLevelFountain = game.buildLevelFountain*1 + 1;
					commonBuild();
					return true;
				}
			}
			if (Structure==="Stash") {
				if (game.gold >= Math.pow(config.costStash,(game.buildLevelStash*1 + 1)) && game.buildLevelTreasury*1 > 0) {
					game.gold               = game.gold - Math.pow(config.costStash,(game.buildLevelStash*1 + 1));
					game.buildLevelStash    = game.buildLevelStash*1 + 1;
					commonBuild();
					return true;
				}
			}
			if (Structure==="Inn") {
				if (game.gold >= Math.pow(config.costInn,(game.buildLevelInn*1 + 1))) {
					game.gold               = game.gold - Math.pow(config.costInn,(game.buildLevelInn*1 + 1));
					game.buildLevelInn      = game.buildLevelInn*1 + 1;
					commonBuild();
					return true;
				}
			}
			function commonBuild() {
				updateResources();
				composite();
				updateButtonCaptions();
			}
		},
		hireTreasuryGuard : function () {
			if (game.buildLevelTreasury >= 1) {
				question = localeStrings[18].replace("%arg1",config.treasuryGuardPriceHire).replace("%arg2",config.treasuryGuardPricePayroll);;
				showModal(1, '', game.hireTreasuryGuardCallback, question,  localeStrings[32], localeStrings[33])
			} else {
				alertMsg = localeStrings[21];
				showModal(0, '', getAck, alertMsg,  localeStrings[60], '')
			}
			function afterAnswer() {
				if (answer === 2) {
					if (game.gold >= config.treasuryGuardPriceHire) {
						game.treasuryGuard = game.treasuryGuard*1 + 1;
						game.gold          = game.gold - config.treasuryGuardPriceHire;
						msg = localeStrings[19];
						postEventLog(msg);
						updateResources();
					}
					else {
						msg = localeStrings[20];
						postEventLog(msg);
					}
				}
			}
			game.hireTreasuryGuard.returnAnswer = afterAnswer;
		},
		hireTreasuryGuardCallback : function () {
			console.log("debug");
			if (answer === 2) {
				if (game.gold >= config.treasuryGuardPriceHire) {
					game.treasuryGuard = game.treasuryGuard*1 + 1;
					game.gold          = game.gold - config.treasuryGuardPriceHire;
					msg = localeStrings[19];
					postEventLog(msg);
					updateResources();
				}
				else {
					msg = localeStrings[20];
					postEventLog(msg);
				}
			}
		},
		fireTreasuryGuard : function () {
			if (game.treasuryGuard > 0) {
				showModal(1, '', game.fireTreasuryGuardCallback, localeStrings[22],  localeStrings[32], localeStrings[33])
			} else {
				msg = localeStrings[24];
				postEventLog(msg);
			}
		},
		fireTreasuryGuardCallback : function () {
			if (answer === 2) {
				game.treasuryGuard      = game.treasuryGuard*1 - 1;
				msg = localeStrings[23];
				postEventLog(msg);
				updateResources();
			}
		},
		deathPenalty : function () {
			if (game.buildLevelGallows > 0) {
				if (game.pop > 2) {
					game.pop      = game.pop - 1;
					gold_was      = game.gold;
					gold_limit    = game.goldLimit();
					gold_possible = game.gold*1+Math.floor((Math.random() * game.gold)/10 + 1);
					if (gold_possible > gold_limit) {
						game.gold = gold_limit;
						msg = localeStrings[3];
						postEventLog(msg);
					} else {
						game.gold = gold_possible;
					}
					gold_incr     = game.gold - gold_was;
					rnd = Math.floor((Math.random() * 6) + 1);
					reason = localeStrings[24+rnd]
					msg = localeStrings[34].replace("%arg1", reason);
					postEventLog(msg);
					msg = localeStrings[35].replace("%arg1", gold_incr);
					postEventLog(msg);
				} else {
					msg = localeStrings[36];
					alert(msg);
				}
				updateResources();
			}
		},
		putOutFire : function () {
			if (game.fire === 1) {
				question = localeStrings[39].replace("%arg1", config.costPutOutFire)
				showModal(1, '', game.putOutFireCallback, question,  localeStrings[32], localeStrings[33])

			}
		},
		putOutFireCallback : function () {
			if (answer === 2) {
				if (game.gold >= config.costPutOutFire) {
					game.fire = 0;
					game.gold = game.gold - config.costPutOutFire;
					document.getElementById("fire_graphics").setAttribute("style", "position:absolute; top:200px; left:200px; z-index=100; display:none");
					document.getElementById("buttonPutOutFire").setAttribute("style", "top:390px; left: 20px; display:none");
					msg = localeStrings[40];
					postEventLog(msg);
					updateResources();
				}
				else {
					msg = localeStrings[20];
					postEventLog(msg);
				}
			} else {
				msg = localeStrings[41];
				postEventLog(msg);
			}
		},
		theftFromTreasury : function () {
			rndThieves = Math.floor((Math.random() * treasuryGuard) + 1);
			if (rndThieves === 1) {
				goldLost      = Math.floor(Math.random() * (game.gold/(1+game.buildLevelStash))+1);
				game.gold     = game.gold - goldLost;
				msg = localeStrings[42].replace("%arg1", goldLost);
				postEventLog(msg);
				updateResources();
			}
		},
		startFire : function () {
			if (game.fire === 0) {
				rnd = Math.floor((Math.random() * 3) + 1);
				if (rnd === 1) {
					msg = localeStrings[38];
					postEventLog(msg);
					game.fire = 1;
					composite();
					//TODO make a certain building in fire, not just "city"
					if (game.buildLevelD == 1) {
						ceil = 1
					}
					if (game.buildLevelD == 2) {
						ceil = 2
					}
					rnd = Math.floor((Math.random() * 2) + 0);
					if (rnd === 0) {
						//	document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
					}
					if (rnd === 1) {
						//	document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
					}
					if (rnd === 0) {
						//	document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
					}
				}
			} else {
				//you can't get another fire, while you do have previous still burning your city. For now.
			}
		},
		winLottery : function () {
			msg = localeStrings[43].replace("%arg1", config.lotteryPrize);
			postEventLog(msg);
			game.gold = game.gold + config.lotteryPrize;
			updateResources();
		}
	};
	//init const-variables
	var config = {
		costWall:2,
		costTower:4,
		costHome:2,
		costTreasury:20,
		costGallows:50,
		costFountain:50,
		costStash:50,
		costInn:20,
		lotteryPrize:50,
		treasuryGuardPriceHire:20,
		treasuryGuardPricePayroll:25,
		costPutOutFire:20,
		sizeMapX:12,
		sizeMapY:12
	}
	//init service variables
	var cnt_cursession= 0;
	var csum          = 0;
	var delimiter     = ";"
	var redraw        = 0;
	var whatDraw      = "";
	var minBL         = 0;
	var mapCreated    = 0;
	updateResources();
	populatePatchnotes();
	generateMap();
	var autosaveObject;
	setupAutosave();//DEBUG
	composite();
	//init timers
	setInterval(resourcesTimer, 30000);
	setInterval(rndEvents, 100000);
	include('localisation.js',function(){
		loadStartLocale();
		console.log('we are in first level include after loadStartLocale()');
	});
	//functions
	function checkPop() {
		//TODO populate the tab!!!;
		if (game.years.length > 10) {
			//select the latest 10
			for (i=0;i<10;i++) {
				var year = document.getElementById("popStatK");
				year.innerHTML = year.innerHTML +' '+ game.years[game.years.length-10+i];
				var pop = document.getElementById("popStatV");
				//TODO ADD FIXED LENGTH
				pop.innerHTML  = pop.innerHTML  +' '+ game.pops[game.years.length-10+i];
				console.log('period is '+game.years[game.years.length-10+i]+' and pop is '+game.pops[game.years.length-10+i]);
			}
		} else {
			if (game.years.length > 0) 
			{
				//TODO
			} else {
				// nothing to show
			}
		}
		openTab(null, 'tabPopulation');
	}
	function getAck() {
		//
	}
	function reloadLang() {
		var x = document.getElementById("selectLng").selectedIndex;
		var y = document.getElementById("selectLng").options;
		language = y[x].value; //y[x].id, text, index
		loadLocale(language);
	}
	function localeCallback(returnLanguage) {
		if (returnLanguage==='en-US') {
			document.getElementById("selectLng").selectedIndex=0;
		}
		if (returnLanguage==='ru-RU') {
			document.getElementById("selectLng").selectedIndex=1;
		}
		document.getElementById("buttonPutOutFire").innerText    = localeStrings[53];
		document.getElementById("buttonDeathPenalty").innerText  = localeStrings[54];
		document.getElementById("saveGameButton").innerText      = localeStrings[44];
		document.getElementById("loadGameButton").innerText      = localeStrings[45];
		document.getElementById("tabCity").innerText             = localeStrings[46];
		document.getElementById("tabExplore").innerText          = localeStrings[47];
		document.getElementById("tabSettings").innerText         = localeStrings[48];
		document.getElementById("tabGarrison").innerText         = localeStrings[49];
		document.getElementById("tabBuilding").innerText         = localeStrings[50];
		document.getElementById("tabAbout").innerText            = localeStrings[51];
		document.getElementById("tabDiscord").innerText          = localeStrings[52];
		document.getElementById("labelSettings").innerText       = localeStrings[66];
		document.getElementById("buttonExportGame").innerText    = localeStrings[67];
		document.getElementById("buttonImportGame").innerText    = localeStrings[68];
		document.getElementById("labelAutosave").innerText       = localeStrings[69];
		document.getElementById("labelGarrison").innerText       = localeStrings[91];
		document.getElementById("buttonFireGuard").innerText     = localeStrings[92];
		document.getElementById("buttonHireGuard").innerText     = localeStrings[93];
		document.getElementById("labelBuilding").innerText       = localeStrings[106];
		document.getElementById("lblAboutGame").innerHTML        = localeStrings[131].replace("%arg1",config.treasuryGuardPriceHire).replace("%arg2",config.treasuryGuardPricePayroll);
		//TODO check if this is first callback in the session or not
		//if (firstLoad===true) {
		welcomeMsg();
		//	firstLoad = false;
		//}
		updateButtonCaptions();
	}
	function welcomeMsg(){
		postEventLog(localeStrings[0]);
		postEventLog(localeStrings[1]);
		postEventLog(localeStrings[2]);
	}
	function postEventLog(msgEventLog) {
		document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+msgEventLog;
		scrollDown();
	}
	function generateMap() {
		//generate landscape
		game.myMapLand=[];
		for (i=0;i<config.sizeMapX;i++) {
			game.myMapLand.push([]);
		}
		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				//for now, all map is just green grass
				game.myMapLand[i][j] = 0; //Math.floor(Math.random()*10);
			}
		}
		//place the castle
		//castle on X axis has 3 points //144px
		//minus one because of 0..11
		//minus one for right part of the castle
		//plus  one for left  part of the castle
		//to both right and left parts could be draw on the map
		game.castleX = Math.floor(Math.random()*(config.sizeMapX-2))+1
		//castle on Y axis has 2 points // 96px
		//minus one because of 0..11
		//so  minus one for the roof of the castle
		//and plus  one for the road to the casle
		game.castleY = Math.floor(Math.random()*(config.sizeMapY-2))+1
		console.log('castleX is '+game.castleX+' and castleY is '+game.castleY);

		//castle(enter) = 10
		//castle(other) = 11
		//castle(point) = 12 //from this point we draw a castle
		//mountain      = 20
		//forest        = 1..3
		//hero          = 40
		//monster       = 50

		game.myMapObjects=[];
		for (i=0;i<config.sizeMapX;i++) {
			game.myMapObjects.push([]);
		}

		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				game.myMapObjects[i][j]=0;

			}
		}
		game.myMapObjects[game.castleX][game.castleY]=10;
		game.myMapObjects[game.castleX-1][game.castleY]=11;
		game.myMapObjects[game.castleX+1][game.castleY]=11;

		game.myMapObjects[game.castleX][game.castleY-1]=11;
		game.myMapObjects[game.castleX-1][game.castleY-1]=12;
		game.myMapObjects[game.castleX+1][game.castleY-1]=11;

		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				if (game.myMapObjects[i][j]===0) {
					rnd = Math.floor((Math.random() * 12) + 1);
					if (rnd > 3) {
						rnd = 0
					}
					game.myMapObjects[i][j]=rnd;
				}
			}
		}
		game.myMapObjects[game.castleX][game.castleY+1]=0;//just to be sure there are nothing to block path to a castle
		//RemovableObjects
		//The hero, first of all
		game.myMapRemObjects=[];
		for (i=0;i<config.sizeMapX;i++) {
			game.myMapRemObjects.push([]);
		}
		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				game.myMapRemObjects[i][j]=0;
			}
		}
		game.myMapRemObjects[game.castleX][game.castleY+1]=40;
		mapCreated = 1;
		composite_gm();
	}
	function populatePatchnotes() {
		msg = "version 1.0.205";
		writeToTextArea(msg);
		msg = "all objects on the city tab now is clickable";
		writeToTextArea(msg);

		msg = "version 1.0.199";
		writeToTextArea(msg);
		msg = "now the game generate the adventure map";
		writeToTextArea(msg);

		msg = "version 1.0.198";
		writeToTextArea(msg);
		msg = "done German translation";
		writeToTextArea(msg);

		msg = "version 1.0.191";
		writeToTextArea(msg);
		msg = "hiring guardsmen now done with dialogue.js";
		writeToTextArea(msg);

		msg = "version 1.0.190";
		writeToTextArea(msg);
		msg = "imported dialogue.js";
		writeToTextArea(msg);

		msg = "version 1.0.189";
		writeToTextArea(msg);
		msg = "made a language selector in Settings tab";
		writeToTextArea(msg);

		msg = "version 1.0.186";
		writeToTextArea(msg);
		msg = "made Russian translation";
		writeToTextArea(msg);

		msg = "version 1.0.180";
		writeToTextArea(msg);
		msg = "clean mess with version numeration. somewhat";
		writeToTextArea(msg);

		msg = "version 1.0.179";
		writeToTextArea(msg);
		msg = "fixed a bug with lottey. Added Discord widget. Added periods counter";
		writeToTextArea(msg);

		msg = "version 1.0.178";
		writeToTextArea(msg);
		msg = "a few minor labels\' corrections";
		writeToTextArea(msg);

		msg = "version 1.0.177";
		writeToTextArea(msg);
		msg = "fixed bug with About tab";
		writeToTextArea(msg);

		msg = "version 1.0.176";
		writeToTextArea(msg);
		msg = "due to the author\'s error, the version now is 1.0.175. Do not git push with --force!";
		writeToTextArea(msg);

		msg = "version 1.0.125";
		writeToTextArea(msg);
		msg = "fixed the bug, then player can't afford treasury upgrade and it's already full";
		writeToTextArea(msg);
		msg = "renamed About to How to Play";
		writeToTextArea(msg);

		msg = "version 1.0.124";
		writeToTextArea(msg);
		msg = "finnally, my game running by the object under the hood";
		writeToTextArea(msg);

		msg = "version 1.0.124";
		writeToTextArea(msg);
		msg = "finnaly, my game running by the object under the hood";
		writeToTextArea(msg);

		msg = "version 1.0.102";
		writeToTextArea(msg);
		msg = "added tab About game"+"\n"+
				"thus close #107";
		writeToTextArea(msg);

		msg = "version 1.0.99";
		writeToTextArea(msg);
		msg = "added Yandex Metrica"+"\n"+
				"fix #105 close #103 #70 #102 #85 #101 ";
		writeToTextArea(msg);

		msg = "version 1.0.95";
		writeToTextArea(msg);
		msg = "added Google analytics. Tuned gold limit";
		writeToTextArea(msg);

		msg = "version 1.0.94";
		writeToTextArea(msg);
		msg = "treasury limit now fixed from bug (close #80)";
		writeToTextArea(msg);

		msg = "version 1.0.93";
		writeToTextArea(msg);
		msg = "another bug with stash/treasury loading from save";
		writeToTextArea(msg);

		msg = "version 1.0.92";
		writeToTextArea(msg);
		msg = "another bug with fire in the city";
		writeToTextArea(msg);

		msg = "version 1.0.91";
		writeToTextArea(msg);
		msg = "compress resources close #73, tried singleton (hope it work), and fix #75";
		writeToTextArea(msg);

		msg = "version 1.0.89";
		writeToTextArea(msg);
		msg = "now with shiny messages in chat about execution";
		writeToTextArea(msg);

		msg = "version 1.0.88";
		writeToTextArea(msg);
		msg = "execution button";
		writeToTextArea(msg);

		msg = "version 1.0.87";
		writeToTextArea(msg);
		msg = "set build buttons invisible for Gallows-Fountain when Fountain-Gallows is built";
		writeToTextArea(msg);

		msg = "version 1.0.79";
		writeToTextArea(msg);
		msg = "gallows prevent building fountain, fountain prevent building gallows and stash requires treasury";
		writeToTextArea(msg);

		msg = "version 1.0.78";
		writeToTextArea(msg);
		msg = "bugfix #34 Autosave now implemented"+"\n"+
				"bugfix #59 new variables don't brick old saves";
		writeToTextArea(msg);

		msg = "version 1.0.76";
		writeToTextArea(msg);
		msg = "bugfix #39 Save/Load doesn't apply on fire in the city"+"\n"+
				"bugfix #42 Prevent load game if there no saves around"+"\n"+
				"bugfix #51 Save and Load with confirmation"+"\n"+
				"bugfix #54 Hiring treasury guards available only if treasury is built"+"\n"+
				"close #55 Added image of treasury guard";
		writeToTextArea(msg);

		msg = "version 1.0.72";
		writeToTextArea(msg);
		msg = "bugfix #29, #47, #48. No defence button after load"
		writeToTextArea(msg);

		msg = "version 1.0.70";
		writeToTextArea(msg);
		msg = "bugfix #44. Now it indicates if gold increased, decreased or not changed"
		writeToTextArea(msg);

		msg = "version 1.0.69";
		writeToTextArea(msg);
		msg = "bugfix #43 (word 'gold' appears after variable, when thieves stole some gold. fix #40"
		writeToTextArea(msg);

		msg = "version 1.0.68";
		writeToTextArea(msg);
		msg = "Bug fixes #35";
		writeToTextArea(msg);

		msg = "version 1.0.66";
		writeToTextArea(msg);
		msg = "You now can fire guardsmen"
		writeToTextArea(msg);

		msg = "version 1.0.65";
		writeToTextArea(msg);
		msg = "Bug fix #30. You're need to hire your treasury guards again, because save file is partially broken"
		writeToTextArea(msg);

		msg = "version 1.0.64";
		writeToTextArea(msg);
		msg = "Added new tab 'Building'. All building buttons move to 'Building' tab. Added firing procedure for treasury guardsmen (not only hiring for now). Added treasury building. As for now it does nothing, but it exists now."
		writeToTextArea(msg);
	}
	function writeToTextArea(msg) {
		document.getElementById("patchnotes").value = document.getElementById("patchnotes").value+"\r\n"+msg;
	}
	function setupAutosave() {
		if (game.o_autosave==0) {
			if (typeof autosaveObject !== 'undefined') {
				clearInterval(autosaveObject);
			}
			document.getElementById("autosaveImg").setAttribute("src","resources/button_red.png");
		} else {
			autosaveObject = setInterval(autosaveGame, 40000);
			document.getElementById("autosaveImg").setAttribute("src","resources/button_green.png");
		}
	}
	function changeAutosave() {
		if (game.o_autosave==0) {
			game.o_autosave = 1;
			setupAutosave();
		} else {
			game.o_autosave = 0;
			setupAutosave();
		}
	}
	function autosaveGame() {
		saveGame("silent");
	}
	function exportGame() {
		stringSavegame = JSON.stringify(game);
		document.getElementById("savestring").value = btoa(stringSavegame);
	}
	function importGame() {
		save64 = prompt(localeStrings[16],localeStrings[17]);
		if (save64 != null) {
			try {
				saveLine  = atob(save64);
				saveArray = saveLine.split(delimiter);
				gameTemp  = JSON.parse(saveArray[0]);
				for (var propertyName in gameTemp) { game[propertyName] = gameTemp[propertyName]; }
				//options   = JSON.parse(saveArray[1]);
				setupAutosave();
				composite();
				updateResources();
				updateButtonCaptions();
				document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+localeStrings[12];
				scrollDown();
				//TODO
				//} else {
				//	alert ("save file was modified. Too bad");
				//}
			}
			catch(err) {
				console.log(err);
			}
		}
	}
	function saveGame(saveConfirmation) {
		if (saveConfirmation=="silent") {
			writeSave();
		} else {
			question = localeStrings[15];
			showModal(1, '', saveGameCallback, question,  localeStrings[32], localeStrings[33])
		}
	}
	function saveGameCallback() {
		if (answer === 2) {
			writeSave();
		}
	}
	function writeSave(){
		localStorage.setItem('game', JSON.stringify(game));
		//localStorage.setItem('config', JSON.stringify(options));
		document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+localeStrings[11];
		scrollDown();
	}
	function loadGame() {
		question = localeStrings[13];
		showModal(1, '', loadGameCallback, question,  localeStrings[32], localeStrings[33])
	}
	function loadGameCallback() {
		if (answer === 2) {
			if (localStorage.getItem('game')!=null){
				//Object.assign(game, JSON.parse(localStorage.getItem('game')));//DOESN'T WORK IN IE AT ALL.
				gameTemp = JSON.parse(localStorage.getItem('game'));
				for (var propertyName in gameTemp) { game[propertyName] = gameTemp[propertyName]; }
				//options  = JSON.parse(localStorage.getItem('options'));
				setupAutosave();
				composite();
				updateResources();
				updateButtonCaptions();
				document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+localeStrings[12];
				scrollDown();
			} else {
				//TODO DO NOT SHOW loadGame BUTTON UNTIL WE DO HAVE A SAVEGAME!!!!
				alert(localeStrings[14]);
			}
		}
	}
	function updateButtonCaptions(){
		nextLvlHome           = game.buildLevelH*1+1;
		nextLvlPriceHome      = Math.pow(config.costHome,(game.buildLevelH*1+1));
		document.getElementById("homes").innerHTML=localeStrings[107].replace("%arg1",nextLvlHome).replace("%arg2",nextLvlPriceHome);

		nextLvlTreasury       = game.buildLevelTreasury*1+1;
		nextLvlPriceTreasury  = Math.pow(config.costTreasury,(game.buildLevelTreasury*1+1));
		document.getElementById("treasury").innerHTML=localeStrings[110].replace("%arg1",nextLvlTreasury).replace("%arg2",nextLvlPriceTreasury);

		nextLvlGallows        = game.buildLevelGallows*1+1;
		nextLvlPriceGallows   = Math.pow(config.costGallows,(game.buildLevelGallows*1+1));
		document.getElementById("buttonBldGallows").innerHTML=localeStrings[111].replace("%arg1",nextLvlGallows).replace("%arg2",nextLvlPriceGallows);

		nextLvlFountain       = game.buildLevelFountain*1+1;
		nextLvlPriceFountain  = Math.pow(config.costFountain,(game.buildLevelFountain*1+1));
		document.getElementById("buttonBldFountain").innerHTML=localeStrings[112].replace("%arg1",nextLvlFountain).replace("%arg2",nextLvlPriceFountain);

		nextLvlStash          = game.buildLevelStash*1+1;
		nextLvlPriceStash     = Math.pow(config.costStash,(game.buildLevelStash*1+1));
		document.getElementById("buttonBldStash").innerHTML=localeStrings[113].replace("%arg1",nextLvlStash).replace("%arg2",nextLvlPriceStash);

		nextLvlInn            = game.buildLevelInn*1+1;
		nextLvlPriceInn       = Math.pow(config.costInn,(game.buildLevelInn*1+1));
		document.getElementById("buttonBldInn").innerHTML=localeStrings[114].replace("%arg1",nextLvlInn).replace("%arg2",nextLvlPriceInn);
		if (game.buildLevelD == 0) {
			document.getElementById("defence").innerHTML=localeStrings[108].replace("%arg1",game.buildLevelD+1).replace("%arg2",config.costWall);
			var towerClick = "game.Build("+"\'Wall\'"+")";
			document.getElementById("defence").setAttribute("onclick", towerClick);
		}
		if (game.buildLevelD == 1) {
			document.getElementById("defence").innerHTML=localeStrings[109].replace("%arg1",game.buildLevelD+1).replace("%arg2",config.costTower);
			var towerClick = "game.Build("+"\'Tower\'"+")";
			document.getElementById("defence").setAttribute("onclick", towerClick);
		}
		if (game.buildLevelD == 2) {
			document.getElementById("defence").setAttribute("style", "display:none");
		}
		if (game.buildLevelFountain > 0) {
			document.getElementById("buttonBldGallows").setAttribute("style", "display:none");
		}
		if (game.buildLevelGallows > 0) {
			document.getElementById("buttonBldFountain").setAttribute("style", "display:none");
			document.getElementById("buttonDeathPenalty").setAttribute("style", "top:430px; left: 20px");
		}
	}
	function getTime(type) {
		var d = new Date();
		var hh = d.getHours();
		var mm = d.getMinutes();
		var ss = d.getSeconds();
		if (hh < 10) {
			hh = "0"+hh;
		}
		if (mm < 10) {
			mm = "0"+mm;
		}
		if (ss < 10) {
			ss = "0"+ss;
		}
		if (type=="0") {
			n = hh+":"+mm;
		}
		if (type=="1") {
			n = hh+":"+mm+":"+ss;
		}
		return n;
	}
	function scrollDown(){
		var textarea = document.getElementById("console_n_chat");
		if(textarea.selectionStart === textarea.selectionEnd) {
			textarea.scrollTop = textarea.scrollHeight;
		}
	}
	function updateResources() {
		document.getElementById("gold").innerHTML          = game.gold;
		document.getElementById("pop").innerHTML           = game.pop;
		document.getElementById("treasuryGuard").innerHTML = game.treasuryGuard;
	}
	function updateImagesBuildingTab () {
		//TODO
	}
	function askPlayer(question, typeofasking) {
		if (typeofasking === 1) {
			playerDecision = confirm(question);
		}
		return playerDecision;
	}
	function showModal(typeofModal, dlgImage, dlgCallback, dlgMessage,  dlgAnswerOne, dlgAnswerTwo) {
		if (typeofModal===0) {
			myCanvas(dlgImage, dlgCallback, dlgMessage,  dlgAnswerOne, dlgAnswerTwo);
		}
		if (typeofModal===1) {
			myCanvas(dlgImage, dlgCallback, dlgMessage,  dlgAnswerOne, dlgAnswerTwo);
		}
		if (typeofModal===2) {
			//TODO PROMTS
		}
	}
	//timers
	function resourcesTimer() {
		game.calculateTurn();
	}
	function rndEvents() {
		rnd = Math.floor((Math.random() * 12) + 1);
		//rnd = 2;//debug
		switch (rnd) {
			case 1:
				game.theftFromTreasury();
				break;
			case 2:
				game.startFire();
				break;
			case 3:
				//
				break;
			case 4:
				//
				break;
			case 5:
				//
				break;
			case 6:
				//
				break;
			case 7:
				//
				break;
			case 8:
				//
				break;
			case 9:
				//
				break;
			case 10:
				//
				break;
			case 11:
				//
				break;
			case 12:
				game.winLottery();
				break;
			default:
				alert("error on switch/case function");
		}
	}
</script>
<script>
	function openTab(evt, tabName) {
		var i, tabcontent, tablinks;
		tabcontent = document.getElementsByClassName("tabcontent");
		for (i = 0; i < tabcontent.length; i++) {
			tabcontent[i].style.display = "none";
		}
		tablinks = document.getElementsByClassName("tablinks");
		for (i = 0; i < tablinks.length; i++) {
			tablinks[i].className = tablinks[i].className.replace(" active", "");
		}
		document.getElementById(tabName).style.display = "block";
		if (evt !== null) {
			evt.currentTarget.className += " active";
		}
	}
	// Get the element with id="defaultOpen" and click on it
	document.getElementById("tabCity").click();
</script>
<script async src="dialogue.js"></script>
<!--<script src="localisation.js"></script>-->
<!--Google Analytics. Sorry guys and girls, but I need some analytic from the game. Feel free to block it -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111661515-1"></script>
<script async>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'UA-111661515-1');
</script>
<!-- Yandex.Metrika counter. The same -->
<script type="text/javascript" >
	(function (d, w, c) {
		(w[c] = w[c] || []).push(function() {
			try {
				w.yaCounter47225574 = new Ya.Metrika({
					id:47225574,
					clickmap:true,
					trackLinks:true,
					accurateTrackBounce:true,
					webvisor:true
				});
			} catch(e) { }
		});
		var n = d.getElementsByTagName("script")[0],
				s = d.createElement("script"),
				f = function () { n.parentNode.insertBefore(s, n); };
		s.type = "text/javascript";
		s.async = true;
		s.src = "https://mc.yandex.ru/metrika/watch.js";
		if (w.opera == "[object Opera]") {
			d.addEventListener("DOMContentLoaded", f, false);
		} else { f(); }
	})(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/47225574" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
</body>
</html>
